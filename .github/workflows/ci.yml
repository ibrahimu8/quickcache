name: CI - Build and Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libzstd-dev
          
    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install openssl curl sqlite zstd
        
    - name: Build QuickCache
      run: |
        make clean
        make
        ls -la buildcache
        file buildcache
    
    - name: Run smoke tests
      run: |
        # Test 1: Help command
        ./buildcache --help
        # Test 2: Stats
        ./buildcache --stats
        # Test 3: Simple compilation
        echo "int main(){return 0;}" > /tmp/test.c
        ./buildcache gcc -c /tmp/test.c -o /tmp/test.o 2>&1 || true
        rm -f /tmp/test.c /tmp/test.o

  test-android:
    name: Test Android/NDK compatibility
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Android NDK
      uses: android-actions/setup-android@v3
    
    - name: Build with NDK compiler
      run: |
        # Try to build with NDK-like flags
        make clean
        CC=clang CFLAGS="-target aarch64-linux-android21" make || echo "NDK build attempted"
        # The build might fail due to missing Android libs, but that's OK for CI

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for compilation warnings
      run: |
        make clean
        # Build with all warnings enabled
        make 2>&1 | tee build.log
        # Count warnings (excluding deprecation)
        WARNINGS=$(grep -c "warning:" build.log || true)
        echo "Total warnings: $WARNINGS"
        if [ $WARNINGS -gt 10 ]; then
          echo "⚠️  Too many warnings!"
          exit 1
        fi
    
    - name: Check for memory issues (Valgrind)
      continue-on-error: true  # Optional check
      run: |
        sudo apt-get install -y valgrind
        echo "int main(){return 0;}" > test.c
        ./buildcache gcc test.c -o testprog
        valgrind --leak-check=full ./testprog
        rm -f test.c testprog
